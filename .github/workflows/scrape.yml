name: Scrape EAMCET Results (Mega Job)

on:
  workflow_dispatch:
    inputs:
      districts:
        description: 'Comma-separated district codes (e.g. 11,12,13 or ALL)'
        required: true
        default: '11,12,13'
      workers:
        description: 'Number of parallel browser workers (max 4 for free tier)'
        required: true
        default: '4'
      serial_start:
        description: 'Serial number start'
        required: true
        default: '1000'
      serial_end:
        description: 'Serial number end (keep under 1850 for 3hr completion)'
        required: true
        default: '1850'

jobs:
  scrape-all:
    name: Mega Scrape Job
    runs-on: ubuntu-latest
    timeout-minutes: 200
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install Dependencies
        run: |
          pip install selenium webdriver-manager

      - name: Run Mega Scraper
        run: |
          python github_scraper.py \
            --districts "${{ inputs.districts }}" \
            --workers "${{ inputs.workers }}" \
            --serial-start "${{ inputs.serial_start }}" \
            --serial-end "${{ inputs.serial_end }}"

      - name: Show Results Summary
        if: always()
        run: |
          echo "=== Results Summary ==="
          if [ -f github_results.csv ]; then
            LINES=$(wc -l < github_results.csv)
            echo "Total records: $((LINES - 1))"
            head -5 github_results.csv
            echo "..."
            tail -5 github_results.csv
          else
            echo "No results file found."
          fi

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eamcet-results
          path: github_results.csv
